version: b{build}
configuration:
  - Release

os: Visual Studio 2017

branches:
  except:
    - gh-pages

init:
  - SET PATH=c:\python37-x64;C:\OpenSSL-win64;%PATH%
  - SET ANSICON=121x90 (121x90)

install:
  - python -V

before_build:
  #- cmd: git clean -dfx
  - cmd: cd c:\tools\vcpkg
  #- cmd: git fetch
  #- cmd: git checkout 8564602d06d7c4ce236f96a4f0f3ba7c2d769cb0
  # don't spend time and energy building debug builds
  - echo.set(VCPKG_BUILD_TYPE release)>> triplets\x64-windows.cmake
  #- .\bootstrap-vcpkg.bat
  - cmd: vcpkg version
  - cmd: cd c:\projects\watchman
  - cmd: python getdeps.py --install-deps -j2 -u
  - cmd: cmake -G "Visual Studio 15 2017 Win64" -DCMAKE_TOOLCHAIN_FILE=c:/tools/vcpkg/scripts/buildsystems/vcpkg.cmake .

build:
  project: ALL_BUILD.vcxproj
  parallel: true

cache:
  - c:\tools\vcpkg\installed\
  - c:\projects\watchman\external\

test_script:
  - "cd node && npm install"
  - cmd: mkdir Watchman
  - cmd: copy Release\watchman.exe Watchman
  - cmd: copy Release\watchman.pdb Watchman
  - cmd: copy LICENSE Watchman/LICENSE.txt
  - cmd: copy README.markdown Watchman
  - cmd: python winbuild\copy-dyn-deps.py Release\watchman.exe Watchman c:\tools\vcpkg\installed\x64-windows\bin external\install\bin external\install\lib
  - cmd: python runtests.py --watchman-path Release\watchman.exe
  - cmd: ctest -C Release --output-on-failure
  #- cmd: python runtests.py --watchman-path Release\watchman.exe --win7

artifacts:
  - path: watchman
    name: watchman
    type: zip

environment:
  global:
    WATCHMAN_BINARY: Release/watchman.exe

platform:
  - x64
