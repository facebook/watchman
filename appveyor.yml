version: b{build}
configuration:
  - Release

os: Visual Studio 2017

branches:
  except:
    - gh-pages

init:
  - SET PATH=c:\python37-x64;C:\OpenSSL-win64;%PATH%
  - SET ANSICON=121x90 (121x90)

install:
  - python -V

build_script:
  - cmd: python build/fbcode_builder/getdeps.py build --num-jobs=2 --src-dir=. --scratch-path=c:/projects/getdeps watchman
  - cmd: mkdir Watchman
  - cmd: python build/fbcode_builder/getdeps.py fixup-dyn-deps --num-jobs=2 --src-dir=. --scratch-path=c:/projects/getdeps watchman Watchman

cache:
  - c:\projects\getdeps\installed\

test_script:
  - "cd node && npm install"
  - cmd: python build/fbcode_builder/getdeps.py test --num-jobs=2 --src-dir=. --scratch-path=c:/projects/getdeps watchman
  #- cmd: mkdir Watchman
  #- cmd: copy Release\watchman.exe Watchman
  #- cmd: copy Release\watchman.pdb Watchman
  #- cmd: copy LICENSE Watchman/LICENSE.txt
  #- cmd: copy README.markdown Watchman
  #- cmd: python winbuild\copy-dyn-deps.py Release\watchman.exe Watchman c:\tools\vcpkg\installed\x64-windows\bin external\install\bin external\install\lib
  #- cmd: python runtests.py --watchman-path Release\watchman.exe --concurrency=1
  #- cmd: ctest -C Release --output-on-failure
  #- cmd: python runtests.py --watchman-path Release\watchman.exe --concurrency=1 --win7

artifacts:
  - path: watchman
    name: watchman
    type: zip

#environment:
#  global:
#    WATCHMAN_BINARY: Release/watchman.exe

platform:
  - x64
