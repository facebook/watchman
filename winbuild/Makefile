# Strict compilation, but suppress deprecation of POSIX and a couple of
# warnings that get generated by the system headers
#PEDANTIC=/Wall /wd4555 /wd4221 /wd4210 /wd4152 /wd4204 /wd4127 /wd4996 /wd4820 /wd4255 /wd4668 /wd4201 /wd4232 /wd4710 /wd4214
CFLAGS=/nologo /MP /WX /Zi /Zo /Oi /MD /I $(MAKEDIR)\winbuild /I $(MAKEDIR) /I $(MAKEDIR)\thirdparty\jansson
LIBS=shlwapi.lib advapi32.lib dbghelp.lib
LINKER=link /nologo /out:$@ /debug /incremental:no /opt:ref /opt:icf /pdb:$(@:.exe=.pdb)

JSON_SRCS=\
	thirdparty\jansson\dump.c \
	thirdparty\jansson\error.c \
	thirdparty\jansson\hashtable.c \
	thirdparty\jansson\load.c \
	thirdparty\jansson\memory.c \
	thirdparty\jansson\pack_unpack.c \
	thirdparty\jansson\strbuffer.c \
	thirdparty\jansson\strconv.c \
	thirdparty\jansson\utf.c \
	thirdparty\jansson\value.c

SRCS_C=\
	$(JSON_SRCS) \
	winbuild\abort.c \
	winbuild\errmap.c \
	winbuild\pathmap.c \
	winbuild\stat.c \
	winbuild\realpath.c \
	winbuild\dir.c \
	winbuild\dirname.c \
	winbuild\asprintf.c \
	winbuild\hostname.c \
	thirdparty\wildmatch\wildmatch.c \
	thirdparty\libart\src\art.c \
	winbuild\time.c \
	winbuild\backtrace.c \
	winbuild\getopt_long.c \
	winbuild\posix_spawn.c \
	winbuild\pthread.c \

SRCS_CPP=\
	argv.cpp \
	envp.cpp \
	ignore.cpp \
	spawn.cpp \
	opt.cpp \
	cfg.cpp \
	clockspec.cpp \
	checksock.cpp \
	fstype.cpp     \
	log.cpp        \
	json.cpp       \
	bser.cpp       \
	expflags.cpp   \
	hash.cpp       \
	ioprio.cpp     \
	opendir.cpp    \
	pending.cpp    \
	perf.cpp       \
	stream.cpp     \
	stream_win.cpp \
	stream_stdout.cpp \
	ht.cpp         \
	cmds\find.cpp     \
	cmds\info.cpp     \
	cmds\log.cpp      \
	cmds\query.cpp    \
	cmds\since.cpp    \
	cmds\reg.cpp      \
	cmds\state.cpp    \
	cmds\subscribe.cpp    \
	cmds\trigger.cpp  \
	cmds\watch.cpp    \
	cmds\debug.cpp    \
	query\base.cpp       \
	query\parse.cpp      \
	query\dirname.cpp    \
	query\eval.cpp       \
	query\glob.cpp       \
	query\type.cpp       \
	query\suffix.cpp     \
	query\match.cpp      \
	query\pcre.cpp       \
	query\name.cpp       \
	query\fieldlist.cpp  \
	query\intcompare.cpp  \
	query\since.cpp      \
	query\empty.cpp      \
	watcher\auto.cpp \
	watcher\win32.cpp \
	listener.cpp   \
	listener-user.cpp   \
	clientmode.cpp \
	main.cpp       \
	root\ageout.cpp       \
	root\crawler.cpp       \
	root\dir.cpp       \
	root\file.cpp       \
	root\init.cpp       \
	root\iothread.cpp       \
	root\lock.cpp       \
	root\notifythread.cpp       \
	root\poison.cpp       \
	root\reap.cpp       \
	root\resolve.cpp       \
	root\stat.cpp       \
	root\symlink.cpp       \
	root\sync.cpp       \
	root\threading.cpp       \
	root\vcs.cpp       \
	root\warnerr.cpp       \
	root\watchlist.cpp       \
	state.cpp      \
	string.cpp     \
	time.cpp

TEST_SRCS_C=\
	thirdparty\tap.c \
	thirdparty\wildmatch\wildmatch.c \
	winbuild\asprintf.c \
	winbuild\time.c \
	winbuild\pthread.c \
	winbuild\backtrace.c \
	winbuild\abort.c \
	winbuild\errmap.c \
	$(JSON_SRCS)

TEST_SRCS_CPP=\
	argv.cpp

TEST_DIR_SRCS=\
	tests\art_test.c \

TEST_DIR_SRCS_CPP=\
	tests\argv.cpp \
	tests\bser.cpp \
	tests\ignore_test.cpp \
	tests\log_stub.cpp \
	tests\log.cpp

OBJS=$(SRCS_CPP:.cpp=.obj) $(SRCS_C:.c=.obj)
TEST_OBJS=$(TEST_SRCS_CPP:.cpp=.obj) $(TEST_SRCS_C:.c=.obj)
TEST_DIR_OBJS=$(TEST_DIR_SRCS:.c=.obj) $(TEST_DIR_SRCS_CPP:.cpp=.obj)
DEPS=$(SRCS_CPP:.cpp=.dep) $(SRCS_C:.c=.dep) $(TEST_SRCS_C:.c=.dep) $(TEST_SRCS_CPP:.cpp=.dep) $(TEST_DIR_SRCS:.cpp=.dep)
TESTS=tests\argv.exe tests\log.exe tests\bser.exe tests\wildmatch_test.exe \
			tests\art.exe tests\ignore.exe tests\pending.exe
COLLECTDEPS=$(CC) $(CFLAGS) /Zs /showIncludes /EHsc $< | cscript /nologo //E:jscript winbuild\depends.js --stdin

.c.dep:
	@echo DEPEND $<
	@$(CC) $(CFLAGS) /Zs /showIncludes /EHsc $< > $@

.cpp.dep:
	@echo DEPEND $<
	@$(CC) $(CFLAGS) /Zs /showIncludes /EHsc $< > $@

{}.cpp{}.obj::
	@echo CXX $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:.\ /c $<
	$(COLLECTDEPS) .

{tests}.c{tests}.obj::
	@echo CC $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:tests\ /c $<
	$(COLLECTDEPS) tests

{tests}.cpp{tests}.obj::
	@echo CXX $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:tests\ /c $<
	$(COLLECTDEPS) tests

{winbuild}.c{winbuild}.obj::
	@echo CC $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:winbuild\ /c $<
	$(COLLECTDEPS) winbuild

{cmds}.cpp{cmds}.obj::
	@echo CXX $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:cmds\ /c $<
	$(COLLECTDEPS) cmds

{query}.cpp{query}.obj::
	@echo CXX $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:query\ /c $<
	$(COLLECTDEPS) query

{watcher}.cpp{watcher}.obj::
	@echo CXX $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:watcher\ /c $<
	$(COLLECTDEPS) watcher

{root}.cpp{root}.obj::
	@echo CXX $<
	$(CC) $(CFLAGS) $(PEDANTIC) /Fo:root\ /c $<
	$(COLLECTDEPS) root

{thirdparty\wildmatch}.c{thirdparty\wildmatch}.obj::
	@echo CC $<
	$(CC) $(CFLAGS) /Fo:thirdparty\wildmatch\ /c $<
	$(COLLECTDEPS) thirdparty\wildmatch

{thirdparty\libart\src}.c{thirdparty\libart\src}.obj::
	@echo CC $<
	$(CC) $(CFLAGS) /Fo:thirdparty\libart\src\ /c $<
	$(COLLECTDEPS) thirdparty\libart\src

{thirdparty\jansson}.c{thirdparty\jansson}.obj::
	@echo CC $<
	$(CC) $(CFLAGS) /Fo:thirdparty\jansson\ /c $<
	$(COLLECTDEPS) thirdparty\jansson

{thirdparty}.c{thirdparty}.obj::
	@echo CC $<
	$(CC) $(CFLAGS) /Fo:thirdparty\ /c $<
	$(COLLECTDEPS) thirdparty

all: remove-config-h watchman.exe build-tests depend susres.exe

remove-config-h:
	-del config.h watchman

# problems with vcvarsall.bat? http://stackoverflow.com/a/10558328/149111
py-build:
	cd python && python ./setup.py clean build_py -c -d . build_ext -i

py-integration: py-build
	python -u runtests.py

# helper for suspending/resuming a target process
susres.exe: winbuild\susres.c
	$(CC) /Fesusres.exe winbuild\susres.c

integration: build-tests susres.exe py-integration

build-tests: $(TESTS)

watchman.exe: $(OBJS)
	@echo LINK $@
	$(LINKER) $(OBJS) $(LIBS)

tests\argv.exe: tests\argv.obj $(TEST_OBJS) \
	tests\log_stub.obj \
	argv.obj \
	string.obj \
	hash.obj \
	log.obj
	@echo LINK $@
	$(LINKER) $** $(LIBS)

tests\art.exe: tests\art_test.obj $(TEST_OBJS) \
  	log.obj \
	tests\log_stub.obj \
	thirdparty\libart\src\art.obj \
	string.obj \
	hash.obj
	@echo LINK $@
	$(LINKER) $** $(LIBS)

tests\ignore.exe: tests\ignore_test.obj $(TEST_OBJS) \
		hash.obj \
		ht.obj \
		ignore.obj \
		string.obj \
		log.obj \
		tests\log_stub.obj \
		thirdparty\libart\src\art.obj
	@echo LINK $@
	$(LINKER) $** $(LIBS)

tests\pending.exe: tests\pending_test.obj $(TEST_OBJS) \
		hash.obj \
		ht.obj \
		ignore.obj \
		pending.obj \
		expflags.obj \
		opendir.obj \
		cfg.obj \
		time.obj \
		string.obj \
		stream_win.obj \
		log.obj \
		tests\log_stub.obj \
		thirdparty\libart\src\art.obj \
		winbuild\pathmap.obj \
		winbuild\stat.obj \
		winbuild\realpath.obj \
		winbuild\dir.obj
	@echo LINK $@
	$(LINKER) $** $(LIBS)

tests\bser.exe: tests\bser.obj bser.obj $(TEST_OBJS) \
	tests\log_stub.obj  \
	string.obj \
	hash.obj \
	log.obj
	@echo LINK $@
	$(LINKER) $** $(LIBS)

tests\log.exe: tests\log.obj log.obj $(TEST_OBJS) \
	string.obj \
	hash.obj
	@echo LINK $@
	$(LINKER) $** $(LIBS)

tests\wildmatch_test.exe: tests\wildmatch_test.obj $(TEST_OBJS) \
	tests\log_stub.obj  \
	string.obj \
	hash.obj \
	log.obj
	@echo LINK $@
	$(LINKER) $** $(LIBS)

.windeps: $(DEPS)
	@cscript /nologo //E:jscript winbuild\depends.js

depend: .windeps

dist:
	-mkdir Watchman
	copy watchman.exe Watchman
	copy watchman.pdb Watchman
	copy LICENSE Watchman\LICENSE.txt
	copy README.markdown Watchman

clean:
	-del $(OBJS) $(TEST_OBJS) $(TEST_DIR_OBJS) *.exe

distclean: clean
	-del $(DEPS) .windeps

!IF EXIST(.windeps)
!INCLUDE .windeps
!ENDIF
